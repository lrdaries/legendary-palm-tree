<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diva's Closet â€” Admin</title>
  <meta name="robots" content="noindex,nofollow" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Modern neutral palette tweaks */
    :root{
      --bg:#f3f6f9;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb; /* blue-600 */
      --glass: rgba(255,255,255,0.6);
    }
    body { background: var(--bg); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#0f172a; }
    .sidebar { background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(248,250,252,0.9)); backdrop-filter: blur(6px); box-shadow: 0 8px 30px rgba(15,23,42,0.06); }
    .card { background: var(--card); border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .fade-section { transition: opacity 260ms ease, transform 260ms ease; }
    .fade-enter { opacity:0; transform: translateY(8px); }
    .fade-enter-active { opacity:1; transform: translateY(0); }
    .fade-exit { opacity:1; transform: translateY(0); }
    .fade-exit-active { opacity:0; transform: translateY(8px); }
    .upload-zone { border: 2px dashed #e6eefc; transition: all 200ms ease; background: linear-gradient(180deg, rgba(37,99,235,0.02), transparent); }
    .upload-zone.dragover { border-color: var(--accent); box-shadow: 0 4px 16px rgba(37,99,235,0.06); }
    .thumbnail { width:100%; height:100%; object-fit:cover; border-radius:8px; }
    /* small responsive tweaks */
    @media (max-width: 1024px) {
      .sidebar { position: fixed; z-index: 30; transform: translateX(0); }
      main { margin-left: 0; }
    }
  </style>

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../site.webmanifest">
  <link rel="shortcut icon" href="../favicon.ico">
</head>
<body class="overflow-x-hidden">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="sidebar w-72 p-6 hidden lg:block">
      <div class="mb-6">
        <h1 class="text-2xl font-semibold">Diva's Closet</h1>
        <p class="text-sm text-slate-500 mt-1">Admin Dashboard</p>
      </div>

      <nav class="space-y-2">
        <a href="#dashboard" data-target="dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 bg-white card shadow-sm">
          <i class="fas fa-chart-pie text-lg text-slate-600"></i>
          <span>Dashboard</span>
        </a>

        <a href="#products" data-target="products" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-slate-700 hover:bg-white/80">
          <i class="fas fa-box text-lg text-slate-600"></i>
          <span>Products</span>
          <span id="product-count" class="ml-auto bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded-full">0</span>
        </a>
      </nav>

      <div class="mt-8">
        <button id="logout-btn" class="w-full bg-red-50 text-red-600 px-3 py-2 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
      </div>
    </aside>

    <!-- Mobile top bar -->
    <div class="lg:hidden fixed top-4 z-40">
      <button id="mobile-menu-toggle" class="bg-white p-2 rounded-lg shadow"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Main content -->
    <main class="flex-1 p-6 max-w-full overflow-x-hidden">
      <!-- Header -->
      <header class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <h2 id="page-title" class="text-xl font-semibold">Dashboard</h2>
          <input id="global-search" type="text" placeholder="Search..." class="px-3 py-2 rounded-lg border border-slate-200 w-72" />
        </div>
        <div class="flex items-center gap-3">
          <button id="quick-action" class="px-3 py-2 bg-white rounded-lg shadow"><i class="fas fa-bell text-slate-600"></i></button>
          <div class="flex items-center gap-2">
            <!--<div class="w-9 h-9 bg-slate-100 rounded-full flex items-center justify-center text-slate-600">A</div>-->
            <div class="text-sm text-slate-600">Admin</div>
          </div>
        </div>
      </header>

      <!-- Sections container -->
      <section id="sections-container" class="space-y-6">
        <!-- DASHBOARD SECTION -->
        <div id="dashboard-section" class="fade-section card p-6 mb-6">
          <!-- modern stat cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="p-4 rounded-lg bg-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">Total Products</p>
                  <h3 id="stat-total-products" class="text-2xl font-semibold">â€”</h3>
                </div>
                <div class="p-3 rounded-lg bg-blue-50">
                  <i class="fas fa-boxes-stacked text-blue-600"></i>
                </div>
              </div>
            </div>

            <div class="p-4 rounded-lg bg-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">In Stock</p>
                  <h3 id="stat-in-stock" class="text-2xl font-semibold">â€”</h3>
                </div>
                <div class="p-3 rounded-lg bg-blue-50">
                  <i class="fas fa-check-circle text-blue-600"></i>
                </div>
              </div>
            </div>

            <div class="p-4 rounded-lg bg-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">Out of Stock</p>
                  <h3 id="stat-out-of-stock" class="text-2xl font-semibold">â€”</h3>
                </div>
                <div class="p-3 rounded-lg bg-blue-50">
                  <i class="fas fa-circle-xmark text-blue-600"></i>
                </div>
              </div>
            </div>

            <div class="p-4 rounded-lg bg-white">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-slate-500">Categories</p>
                  <h3 id="stat-categories" class="text-2xl font-semibold">â€”</h3>
                </div>
                <div class="p-3 rounded-lg bg-blue-50">
                  <i class="fas fa-tags text-blue-600"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent orders placeholder -->
          <div class="mt-6 p-4 bg-white rounded-lg">
            <div class="flex items-center justify-between">
              <h4 class="font-semibold">Recent Orders</h4>
              <button class="text-sm text-slate-600">View all</button>
            </div>
            <div class="mt-4 text-slate-500 text-sm">Connect your orders API to populate this list.</div>
          </div>
        </div>

        <!-- PRODUCTS SECTION -->
        <div id="products-section" class="fade-section hidden">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-semibold">Product Management</h3>
              <p class="text-sm text-slate-500">Manage your catalog â€” create, edit, delete products.</p>
            </div>

            <div class="flex items-center gap-3">
              <button id="export-btn" class="px-3 py-2 rounded-lg bg-white card shadow-sm"><i class="fas fa-download mr-2"></i>Export</button>
              <button id="import-btn" class="px-3 py-2 rounded-lg bg-white card shadow-sm"><i class="fas fa-upload mr-2"></i>Import</button>
              <button id="add-product-btn" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700"><i class="fas fa-plus mr-2"></i> Add Product</button>
            </div>
          </div>

          <!-- Filters -->
          <div class="mb-4 bg-white card p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <input id="filter-search" placeholder="Search products..." class="px-3 py-2 rounded-lg border" />
              <input id="filter-category" placeholder="Category" class="px-3 py-2 rounded-lg border" />
              <select id="filter-status" class="px-3 py-2 rounded-lg border">
                <option value="">All status</option>
                <option value="active">Active</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
              </select>
              <button id="apply-filters" class="px-3 py-2 rounded-lg bg-blue-600 text-white">Apply</button>
            </div>
          </div>

          <!-- Products table -->
          <div class="bg-white card overflow-hidden">
            <table class="w-full">
              <thead class="bg-slate-50">
                <tr class="text-left text-slate-600 text-sm">
                  <th class="px-6 py-3"><input type="checkbox" id="select-all" /></th>
                  <th class="px-6 py-3">Product</th>
                  <th class="px-6 py-3">SKU</th>
                  <th class="px-6 py-3">Category</th>
                  <th class="px-6 py-3">Price</th>
                  <th class="px-6 py-3">Stock</th>
                  <th class="px-6 py-3">Status</th>
                  <th class="px-6 py-3">Actions</th>
                </tr>
              </thead>
              <tbody id="products-table-body" class="text-slate-700">
                <!-- rows injected dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Add/Edit Modal (hidden by default) -->
  <div id="product-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-4xl bg-white rounded-lg overflow-auto max-h-[90vh]">
      <div class="sticky top-0 bg-white p-4 border-b flex items-center justify-between">
        <h3 id="modal-title" class="font-semibold">Add Product</h3>
        <div class="flex items-center gap-2">
          <button id="close-modal" class="text-slate-600"><i class="fas fa-times"></i></button>
        </div>
      </div>

      <form id="product-form" class="p-6 space-y-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- left -->
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-600">Product Name *</label>
              <input id="product-name" required class="w-full px-3 py-2 border rounded-lg" />
            </div>

            <div>
              <label class="text-sm text-slate-600">Description *</label>
              <textarea id="product-description" rows="4" required class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">Category *</label>
                <input id="product-category" required class="w-full px-3 py-2 border rounded-lg" />
              </div>
              <div>
                <label class="text-sm text-slate-600">Brand</label>
                <input id="product-brand" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">SKU *</label>
                <input id="product-sku" required class="w-full px-3 py-2 border rounded-lg" />
              </div>
              <div>
                <label class="text-sm text-slate-600">Barcode</label>
                <input id="product-barcode" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-600">Tags</label>
              <input id="product-tags" placeholder="comma, separated" class="w-full px-3 py-2 border rounded-lg" />
            </div>
          </div>

          <!-- right -->
          <div class="space-y-3">
            <div>
              <label class="text-sm text-slate-600">Images *</label>
              <div id="image-upload-zone" class="upload-zone p-4 rounded-lg text-center cursor-pointer">
                <div class="py-4">
                  <i class="fas fa-cloud-upload-alt text-3xl text-slate-400"></i>
                </div>
                <p class="text-sm text-slate-500">Click or drop images here (PNG/JPG/WebP). Max 5MB each.</p>
                <input id="product-images" type="file" accept="image/*" multiple class="hidden" />
              </div>

              <div class="grid grid-cols-3 gap-2 mt-3" id="image-preview"></div>
              <div class="grid grid-cols-3 gap-2 mt-3" id="existing-images"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">Price (USD) *</label>
                <input id="product-price" required type="number" step="0.01" class="w-full px-3 py-2 border rounded-lg" />
              </div>
              <div>
                <label class="text-sm text-slate-600">Compare Price</label>
                <input id="product-compare-price" type="number" step="0.01" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-slate-600">Stock Quantity *</label>
                <input id="product-stock" type="number" min="0" class="w-full px-3 py-2 border rounded-lg" />
              </div>
              <div>
                <label class="text-sm text-slate-600">Low Stock Alert</label>
                <input id="product-low-stock" type="number" min="0" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-600">Sizes Available</label>
              <div id="sizes-container" class="flex flex-wrap gap-2 mt-2">
                <!-- generated via JS -->
              </div>
            </div>

            <div>
              <label class="text-sm text-slate-600">Colors</label>
              <input id="product-colors" placeholder="Black, White" class="w-full px-3 py-2 border rounded-lg" />
            </div>

            <div>
              <label class="text-sm text-slate-600">Status</label>
              <select id="product-status" class="w-full px-3 py-2 border rounded-lg">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
                <option value="archived">Archived</option>
              </select>
            </div>
          </div>
        </div>

        <!-- SEO -->
        <div class="pt-4 border-t">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="meta-title" placeholder="Meta title" class="px-3 py-2 border rounded-lg" />
            <input id="meta-description" placeholder="Meta description" class="px-3 py-2 border rounded-lg" />
            <input id="url-slug" placeholder="url-slug (optional)" class="px-3 py-2 border rounded-lg" />
          </div>
        </div>

        <div class="flex items-center justify-end gap-3 pt-4 border-t">
          <button type="button" id="cancel-btn" class="px-4 py-2 rounded-lg border">Cancel</button>
          <button type="button" id="save-draft" class="px-4 py-2 rounded-lg bg-slate-600 text-white">Save Draft</button>
          <button type="submit" id="publish-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Publish Product</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Logout confirmation -->
  <div id="logout-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-xl p-6 space-y-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
          <i class="fas fa-sign-out-alt text-xl"></i>
        </div>
        <div>
          <p class="text-sm uppercase tracking-wide text-slate-400">Confirm action</p>
          <h4 class="text-lg font-semibold">Log out</h4>
        </div>
      </div>
      <p class="text-sm text-slate-600 leading-relaxed">
        You will be signed out of the admin dashboard.
      </p>
      <div class="flex items-center gap-3">
        <button id="logout-cancel" class="flex-1 border border-slate-200 text-slate-700 rounded-lg py-2.5 hover:bg-slate-50 transition">
          Cancel
        </button>
        <button id="logout-confirm" class="flex-1 bg-red-500 text-white rounded-lg py-2.5 hover:bg-red-600 transition shadow-sm">
          Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Delete confirmation -->
  <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/40 p-4">
    <div class="w-full max-w-md rounded-2xl bg-white shadow-xl p-6 space-y-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
          <i class="fas fa-trash text-xl"></i>
        </div>
        <div>
          <p class="text-sm uppercase tracking-wide text-slate-400">Confirm action</p>
          <h4 class="text-lg font-semibold text-slate-900">Delete product</h4>
        </div>
      </div>
      <p id="delete-modal-message" class="text-sm text-slate-600 leading-relaxed">
        This will permanently delete the product. This action canâ€™t be undone.
      </p>
      <div class="flex items-center gap-3">
        <button id="delete-cancel" class="flex-1 border border-slate-200 text-slate-700 rounded-lg py-2.5 hover:bg-slate-50 transition">
          Cancel
        </button>
        <button id="delete-confirm" class="flex-1 bg-red-500 text-white rounded-lg py-2.5 hover:bg-red-600 transition shadow-sm">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- notification -->
  <div id="notification-toast" class="fixed top-6 right-6 z-50 hidden">
    <div id="notification-card" class="bg-white p-4 rounded-2xl shadow-lg border border-slate-100 flex items-start gap-3 min-w-[280px] max-w-[360px]">
      <div id="notification-icon" class="w-10 h-10 rounded-xl flex items-center justify-center bg-slate-50 text-slate-600"></div>
      <div class="min-w-0">
        <div id="notification-title" class="font-semibold text-slate-900"></div>
        <div id="notification-message" class="text-sm text-slate-600 break-words"></div>
      </div>
      <button id="notification-close" class="text-slate-400 ml-auto hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    /*
      Modernized dashboard.html (single file)
      - Dashboard & Products sections (toggle)
      - Products CRUD via Fetch API (supports multipart FormData -> images[])
      - Multiple image preview + edit/delete + existing images handling
      - Fade transitions between sections
      - Inline comments throughout for clarity
      - API override: window.__API_BASE_URL__ (set before this script runs)
    */

    // ---------- Configuration ----------
    const DEFAULT_API_BASE = CONFIG.API_BASE_URL + '/admin/products';
    const API_BASE_URL = window.__API_BASE_URL__ || DEFAULT_API_BASE;
    // Note: If your backend expects POST + _method=PUT for file uploads, adjust save logic accordingly.
    
    // ---------- Session check ----------
    function checkAdminSession() {
      // Clear any legacy persistent session
      try { localStorage.removeItem('adminSession'); } catch {}
      const session = sessionStorage.getItem('adminSession');
      if (!session) {
        window.location.href = 'index.html';
        return false;
      }

      const sessionData = JSON.parse(session);
      const hoursSinceLogin = (Date.now() - sessionData.timestamp) / (1000 * 60 * 60);

      // Auto-logout after 24 hours
      if (hoursSinceLogin > 24) {
        sessionStorage.removeItem('adminSession');
        window.location.href = 'index.html';
        return false;
      }

      return true;
    }
    
    // ---------- App state ----------
    let products = [];           // current loaded products
    let isEditing = false;
    let editingProductId = null;

    // ---------- Simple notification helper ----------
    function showNotification(type, title, message) {
      const toast = document.getElementById('notification-toast');
      const icon = document.getElementById('notification-icon');
      const card = document.getElementById('notification-card');
      document.getElementById('notification-title').textContent = title;
      document.getElementById('notification-message').textContent = message;
      const styles = {
        success: { icon: '<i class="fas fa-check"></i>', cls: 'bg-emerald-50 text-emerald-700 border-emerald-100' },
        error: { icon: '<i class="fas fa-exclamation"></i>', cls: 'bg-red-50 text-red-700 border-red-100' },
        info: { icon: '<i class="fas fa-info"></i>', cls: 'bg-blue-50 text-blue-700 border-blue-100' }
      };
      const s = styles[type] || styles.info;
      icon.innerHTML = s.icon;
      icon.className = `w-10 h-10 rounded-xl flex items-center justify-center ${s.cls}`;
      if (card) card.classList.add('shadow-lg');
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 4200);
    }
    document.getElementById('notification-close').addEventListener('click', () => {
      document.getElementById('notification-toast').classList.add('hidden');
    });

    // ---------- Logout modal ----------
    const logoutModal = document.getElementById('logout-modal');
    const logoutConfirmBtn = document.getElementById('logout-confirm');
    const logoutCancelBtn = document.getElementById('logout-cancel');

    function toggleLogoutModal(show) {
      if (!logoutModal) return;
      logoutModal.classList.toggle('hidden', !show);
    }

    function handleLogout() {
      localStorage.removeItem('adminSession');
      sessionStorage.removeItem('adminSession');
      window.location.href = 'index.html';
    }

    logoutCancelBtn.addEventListener('click', () => toggleLogoutModal(false));
    logoutModal.addEventListener('click', (event) => {
      if (event.target === logoutModal) toggleLogoutModal(false);
    });
    logoutConfirmBtn.addEventListener('click', () => handleLogout());

    // ---------- Delete modal ----------
    const deleteModal = document.getElementById('delete-modal');
    const deleteConfirmBtn = document.getElementById('delete-confirm');
    const deleteCancelBtn = document.getElementById('delete-cancel');
    const deleteModalMessage = document.getElementById('delete-modal-message');
    let pendingDeleteId = null;

    function toggleDeleteModal(show) {
      if (!deleteModal) return;
      deleteModal.classList.toggle('hidden', !show);
    }

    deleteCancelBtn?.addEventListener('click', () => {
      pendingDeleteId = null;
      toggleDeleteModal(false);
    });
    deleteModal?.addEventListener('click', (event) => {
      if (event.target === deleteModal) {
        pendingDeleteId = null;
        toggleDeleteModal(false);
      }
    });
    deleteConfirmBtn?.addEventListener('click', async () => {
      const id = pendingDeleteId;
      pendingDeleteId = null;
      toggleDeleteModal(false);
      if (!Number.isFinite(id)) return;
      await deleteProductFromBackend(id);
    });

    // ---------- Navigation (Dashboard <-> Products) ----------
    function setActiveSection(target) {
      // apply fade transitions (simple)
      const sections = { dashboard: document.getElementById('dashboard-section'), products: document.getElementById('products-section') };
      // hide all then show
      Object.keys(sections).forEach(key => {
        const el = sections[key];
        if (!el) return;
        if (key === target) {
          el.classList.remove('hidden');
          el.style.opacity = 0;
          el.style.transform = 'translateY(8px)';
          requestAnimationFrame(() => {
            el.style.transition = 'opacity 180ms ease, transform 180ms ease';
            el.style.opacity = 1;
            el.style.transform = 'translateY(0)';
          });
        } else {
          el.style.transition = 'opacity 140ms ease, transform 140ms ease';
          el.style.opacity = 0;
          el.style.transform = 'translateY(8px)';
          setTimeout(() => el.classList.add('hidden'), 160);
        }
      });

      // update title
      document.getElementById('page-title').textContent = target === 'dashboard' ? 'Dashboard' : 'Products';
      // highlight nav links (sidebar)
      document.querySelectorAll('.nav-link').forEach(a => {
        if (a.dataset.target === target) {
          a.classList.add('bg-white');
        } else a.classList.remove('bg-white');
      });

      // if products section, ensure table shows latest
      if (target === 'products') fetchProducts().catch(()=>{});
    }

    // wire nav (sidebar + mobile)
    document.querySelectorAll('.nav-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveSection(a.dataset.target);
      });
    });

    // mobile menu toggle: simply toggle sidebar visibility
    document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('hidden');
    });

    // ---------- Fetch products (GET) ----------
    async function fetchProducts() {
      const tbody = document.getElementById('products-table-body');
      tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-6 text-center text-slate-500">Loading products...</td></tr>';

      // Get auth token from session
      try { localStorage.removeItem('adminSession'); } catch {}
      const session = sessionStorage.getItem('adminSession');
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      const sessionData = JSON.parse(session);
      const token = sessionData.token;

      try {
        const res = await fetch(API_BASE_URL, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!res.ok) throw new Error('Network response was not ok ' + res.status);
        const data = await res.json();
        products = (data.data || []).map(p => {
          const images = Array.isArray(p.image_urls)
            ? p.image_urls
            : (p.image_url ? [p.image_url] : []);

          return {
            ...p,
            images,
            stock: p.in_stock
          };
        });
        document.getElementById('product-count').textContent = Array.isArray(products) ? products.length : 0;
        updateDashboardStats(products);
        renderProductsTable(products);
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-6 text-center text-red-500">Failed to load products. Check API and CORS.</td></tr>';
        showNotification('error','Load failed','Could not fetch products.');
      }
    }

    function updateDashboardStats(list) {
      const items = Array.isArray(list) ? list : [];

      const totalProductsEl = document.getElementById('stat-total-products');
      const inStockEl = document.getElementById('stat-in-stock');
      const outOfStockEl = document.getElementById('stat-out-of-stock');
      const categoriesEl = document.getElementById('stat-categories');

      const totalProducts = items.length;
      const inStock = items.filter(p => Number(p && p.in_stock) > 0).length;
      const outOfStock = items.filter(p => !Number.isFinite(Number(p && p.in_stock)) || Number(p && p.in_stock) <= 0).length;
      const categories = new Set(items.map(p => String((p && p.category) || '').trim().toLowerCase()).filter(Boolean)).size;

      if (totalProductsEl) totalProductsEl.textContent = String(totalProducts);
      if (inStockEl) inStockEl.textContent = String(inStock);
      if (outOfStockEl) outOfStockEl.textContent = String(outOfStock);
      if (categoriesEl) categoriesEl.textContent = String(categories);
    }

    // ---------- Render products table ----------
    function renderProductsTable(items) {
      const tbody = document.getElementById('products-table-body');
      if (!Array.isArray(items) || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-6 text-center text-slate-500">No products available.</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(p => {
        const imgUrl = (p.images && p.images.length) ? escapeHtml(p.images[0]) : '';
        const price = (p.price != null) ? `$${Number(p.price).toFixed(2)}` : '-';
        const stock = (p.stock != null) ? p.stock : '-';
        const statusBadge = getStatusBadge(p.status, p.stock);
        return `
          <tr class="border-b hover:bg-slate-50 align-top">
            <td class="px-6 py-4"><input type="checkbox" data-id="${p.id}"></td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <div class="w-14 h-14 bg-slate-100 rounded overflow-hidden">
                  ${ imgUrl ? `<img src="${imgUrl}" class="thumbnail" alt="">` : `<div class="w-full h-full flex items-center justify-center text-slate-400"><i class="fas fa-image"></i></div>` }
                </div>
                <div>
                  <div class="font-medium">${escapeHtml(p.name || '')}</div>
                  <div class="text-xs text-slate-500">${(p.colors || []).join(', ')}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-slate-600">${escapeHtml(p.sku || '')}</td>
            <td class="px-6 py-4">${escapeHtml(p.category || '')}</td>
            <td class="px-6 py-4 font-semibold">${price}</td>
            <td class="px-6 py-4">${stock}</td>
            <td class="px-6 py-4">${statusBadge}</td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-3">
                <button data-action="edit" data-id="${p.id}" class="text-blue-600 hover:text-blue-700"><i class="fas fa-edit"></i></button>
                <button data-action="duplicate" data-id="${p.id}" class="text-slate-600 hover:text-slate-700"><i class="fas fa-copy"></i></button>
                <button data-action="delete" data-id="${p.id}" class="text-red-600 hover:text-red-700"><i class="fas fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('products-table-body').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action][data-id]');
      if (!btn) return;

      const id = Number(btn.dataset.id);
      if (!Number.isFinite(id)) return;

      if (btn.dataset.action === 'edit') {
        onEditProduct(id);
      } else if (btn.dataset.action === 'duplicate') {
        onDuplicateProduct(id);
      } else if (btn.dataset.action === 'delete') {
        await onDeleteProduct(id);
      }
    });

    // ---------- Helpers ----------
    function getStatusBadge(status, stock) {
      if (stock === 0) return '<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">Out of stock</span>';
      if (stock != null && stock < 10) return '<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">Low stock</span>';
      if (status === 'active') return '<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Active</span>';
      if (status === 'draft') return '<span class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-full">Draft</span>';
      return `<span class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-full">${escapeHtml(status || '')}</span>`;
    }
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
    }

    // ---------- Save (POST/PUT) with FormData to support multiple images ----------
    async function saveProductToBackend(values, files = []) {
      try {
        // ðŸ†• ADD THE IMAGE UPLOAD CODE HERE (before the existing fetch)
        try { localStorage.removeItem('adminSession'); } catch {}
        const session = sessionStorage.getItem('adminSession');
        if (!session) {
          window.location.href = 'index.html';
          return;
        }
        const sessionData = JSON.parse(session);
        const token = sessionData.token;
        
        // First, upload images if any
        let imageUrls = [];
        if (files && files.length > 0) {
          const formData = new FormData();
          files.forEach(file => {
            formData.append('images', file);
          });

          const uploadResponse = await fetch(`${CONFIG.API_BASE_URL}/admin/products/upload-images`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });

          const uploadResult = await uploadResponse.json();
          if (uploadResult.success) {
            imageUrls = uploadResult.imageUrls;
          } else {
            throw new Error('Image upload failed: ' + uploadResult.message);
          }
        }

        let existingImages = [];
        try {
          existingImages = JSON.parse(values.existingImages || '[]');
        } catch {
          existingImages = [];
        }

        const mergedImages = [...existingImages, ...imageUrls].filter(Boolean);

        // Now create/update the product with the uploaded image URLs
        const productData = {
          name: values.name,
          description: values.description,
          price: parseFloat(values.price),
          category: values.category,
          in_stock: parseInt(values.stock) || 0,
          ...(mergedImages.length ? { image_urls: mergedImages } : {})
        };

        // Determine if this is create or update
        const isUpdate = values.id && values.id !== 'new';
        const url = isUpdate 
          ? `${CONFIG.API_BASE_URL}/admin/products/${values.id}`
          : `${CONFIG.API_BASE_URL}/admin/products`;
        
        const method = isUpdate ? 'PUT' : 'POST';

        console.log(`${isUpdate ? 'ðŸ”„ Updating' : 'âž• Creating'} product...`);

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(productData)
        });

        const result = await response.json();
        
        if (result.success) {
          console.log('âœ… Product saved successfully');
          showNotification('success', 'Success', `Product ${isUpdate ? 'updated' : 'created'} successfully!`);
          
          // Refresh the products table
          await fetchProducts();
          
          // Close modal and reset form
          closeModal();
          resetForm();
        } else {
          throw new Error(result.message || 'Failed to save product');
        }
      } catch (err) {
        console.error('âŒ Error saving product:', err);
        showNotification('error', 'Error', err.message);
      }
    }

    // ---------- Delete (DELETE) ----------
    async function deleteProductFromBackend(id) {
      // Get auth token from session
      try { localStorage.removeItem('adminSession'); } catch {}
      const session = sessionStorage.getItem('adminSession');
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      const sessionData = JSON.parse(session);
      const token = sessionData.token;

      try {
        console.log('ðŸ—‘ï¸  Deleting product:', id);

        const res = await fetch(`${API_BASE_URL}/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || `Delete failed: ${res.status}`);
        }

        console.log('âœ… Product deleted');
        showNotification('success', 'Deleted', 'Product removed successfully');
        await fetchProducts();
      } catch (err) {
        console.error('âŒ Delete error:', err);
        showNotification('error', 'Delete failed', err.message || 'Could not delete product.');
      }
    }

    // ---------- UI actions (edit / duplicate / delete) ----------
    function onEditProduct(id) {
      const p = products.find(x => x.id === id);
      if (!p) return showNotification('error','Not found','Product not in memory');
      isEditing = true; editingProductId = id;
      document.getElementById('modal-title').textContent = 'Edit product';

      // Fill form fields
      document.getElementById('product-name').value = p.name || '';
      document.getElementById('product-description').value = p.description || '';
      document.getElementById('product-category').value = p.category || '';
      document.getElementById('product-brand').value = p.brand || '';
      document.getElementById('product-sku').value = p.sku || '';
      document.getElementById('product-barcode').value = p.barcode || '';
      document.getElementById('product-tags').value = (p.tags || []).join(', ');
      document.getElementById('product-price').value = p.price != null ? p.price : '';
      document.getElementById('product-compare-price').value = p.comparePrice != null ? p.comparePrice : '';
      document.getElementById('product-stock').value = p.stock != null ? p.stock : '';
      document.getElementById('product-low-stock').value = p.lowStock || '';
      document.getElementById('product-colors').value = (p.colors || []).join(', ');
      document.getElementById('product-status').value = p.status || 'active';
      document.getElementById('meta-title').value = p.metaTitle || '';
      document.getElementById('meta-description').value = p.metaDescription || '';
      document.getElementById('url-slug').value = p.urlSlug || '';

      // Show existing images (backend should return array of URLs in p.images)
      const existingEl = document.getElementById('existing-images');
      existingEl.innerHTML = '';
      (p.images || []).forEach((url, idx) => {
        const div = document.createElement('div');
        div.className = 'relative group';
        div.style.height = '96px';
        div.innerHTML = `
          <img src="${escapeHtml(url)}" class="thumbnail" alt="">
          <button data-idx="${idx}" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 opacity-0 group-hover:opacity-100 remove-existing-image"><i class="fas fa-times text-xs"></i></button>
        `;
        existingEl.appendChild(div);
      });

      // store existing images in dataset for backend to parse if needed
      document.getElementById('product-form').dataset.existingImages = JSON.stringify(p.images || []);

      openProductModal();
    }

    function onDuplicateProduct(id) {
      const p = products.find(x => x.id === id);
      if (!p) return;
      isEditing = false; editingProductId = null;
      document.getElementById('modal-title').textContent = 'Duplicate product';
      // fill form with copy data
      document.getElementById('product-name').value = (p.name || '') + ' (Copy)';
      document.getElementById('product-description').value = p.description || '';
      document.getElementById('product-category').value = p.category || '';
      document.getElementById('product-brand').value = p.brand || '';
      document.getElementById('product-sku').value = generateSkuCandidate((p.sku || p.name || '') + ' COPY');
      document.getElementById('product-barcode').value = p.barcode || '';
      document.getElementById('product-tags').value = (p.tags || []).join(', ');
      document.getElementById('product-price').value = p.price != null ? p.price : '';
      document.getElementById('product-compare-price').value = p.comparePrice != null ? p.comparePrice : '';
      document.getElementById('product-stock').value = p.stock != null ? p.stock : '';
      document.getElementById('product-low-stock').value = p.lowStock || '';
      document.getElementById('product-colors').value = (p.colors || []).join(', ');
      document.getElementById('product-status').value = p.status || 'active';

      // clear previews and existing (so user must add images if desired)
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('existing-images').innerHTML = '';
      delete document.getElementById('product-form').dataset.existingImages;

      openProductModal();
    }

    async function onDeleteProduct(id) {
      pendingDeleteId = id;
      const p = products.find(x => x.id === id);
      if (deleteModalMessage) {
        deleteModalMessage.textContent = p && p.name
          ? `This will permanently delete â€œ${p.name}â€. This action canâ€™t be undone.`
          : 'This will permanently delete the product. This action canâ€™t be undone.';
      }
      toggleDeleteModal(true);
    }

    // ---------- Modal controls ----------
    function openProductModal() {
      document.getElementById('product-modal').classList.remove('hidden');
      // small focus
      setTimeout(()=>document.getElementById('product-name').focus(), 120);
    }
    function closeProductModal() {
      document.getElementById('product-modal').classList.add('hidden');
      // reset state
      isEditing = false; editingProductId = null;
      document.getElementById('product-form').reset();
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('existing-images').innerHTML = '';
      delete document.getElementById('product-form').dataset.existingImages;
    }
    document.getElementById('close-modal').addEventListener('click', closeProductModal);
    document.getElementById('cancel-btn').addEventListener('click', closeProductModal);

    // ---------- Image upload & preview handling ----------
    function initImageUpload() {
      const zone = document.getElementById('image-upload-zone');
      const fileInput = document.getElementById('product-images');
      const preview = document.getElementById('image-preview');

      zone.addEventListener('click', () => fileInput.click());

      zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', () => { zone.classList.remove('dragover'); });
      zone.addEventListener('drop', (e) => {
        e.preventDefault(); zone.classList.remove('dragover'); handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

      function handleFiles(filesList) {
        const files = Array.from(filesList);
        // Basic file validations (size/type) could be added here
        files.forEach(file => {
          if (!file.type.startsWith('image/')) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const container = document.createElement('div');
            container.className = 'relative group';
            container.style.height = '96px';
            container.innerHTML = `
              <img src="${ev.target.result}" class="thumbnail" alt="">
              <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 opacity-0 group-hover:opacity-100 remove-preview"><i class="fas fa-times text-xs"></i></button>
            `;
            // remove preview on click
            container.querySelector('.remove-preview').addEventListener('click', () => container.remove());
            preview.appendChild(container);
          };
          reader.readAsDataURL(file);
        });
      }
    }

    // Handle remove of existing image thumbnails (delegated)
    document.addEventListener('click', (e) => {
      const rem = e.target.closest('.remove-existing-image');
      if (rem) {
        rem.closest('.group').remove();
        const form = document.getElementById('product-form');
        const arr = JSON.parse(form.dataset.existingImages || '[]');
        const idx = Number(rem.dataset.idx);
        arr.splice(idx, 1);
        form.dataset.existingImages = JSON.stringify(arr);
      }
    });

    // ---------- Collect form values ----------
    function generateSkuCandidate(base) {
      const raw = String(base || '').trim().toUpperCase();
      const cleaned = raw
        .replace(/[^A-Z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 40);
      const prefix = cleaned || 'SKU';
      const suffix = Math.random().toString(36).slice(2, 8).toUpperCase();
      return `${prefix}-${suffix}`.slice(0, 64);
    }

    function collectFormValues() {
      const sizes = Array.from(document.querySelectorAll('.size-checkbox:checked')).map(c => c.value);
      return {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        category: document.getElementById('product-category').value,
        brand: document.getElementById('product-brand').value,
        sku: document.getElementById('product-sku').value,
        barcode: document.getElementById('product-barcode').value,
        tags: document.getElementById('product-tags').value,
        price: document.getElementById('product-price').value,
        comparePrice: document.getElementById('product-compare-price').value,
        stock: document.getElementById('product-stock').value,
        lowStock: document.getElementById('product-low-stock').value,
        sizes: sizes.join(','),
        colors: document.getElementById('product-colors').value,
        status: document.getElementById('product-status').value,
        metaTitle: document.getElementById('meta-title').value,
        metaDescription: document.getElementById('meta-description').value,
        urlSlug: document.getElementById('url-slug').value,
        existingImages: document.getElementById('product-form').dataset.existingImages || '[]'
      };
    }

    // ---------- Form submit handlers ----------
    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const values = collectFormValues();
      // Gather files from file input (only those still in the input element)
      const fileInput = document.getElementById('product-images');
      const files = document.getElementById('product-images').files;
      await saveProductToBackend(values, Array.from(files));
    });

    // Save draft button: sends with status=draft
    document.getElementById('save-draft').addEventListener('click', async () => {
      const values = collectFormValues();
      values.status = 'draft';
      const files = Array.from(document.getElementById('product-images').files || []);
      await saveProductToBackend(values, files);
    });

    // ---------- Import / Export helpers (client-side) ----------
    document.getElementById('export-btn').addEventListener('click', () => {
      const dataStr = JSON.stringify(products || [], null, 2);
      const dl = document.createElement('a');
      dl.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      dl.download = 'products_export.json';
      dl.click();
    });

    document.getElementById('import-btn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        const txt = await f.text();
        try {
          const imported = JSON.parse(txt);
          // Local merge; optionally POST to backend to persist
          products = [...products, ...imported];
          renderProductsTable(products);
          showNotification('success','Imported','Imported locally. To persist, POST these to your API.');
        } catch (err) {
          showNotification('error','Import failed','Invalid JSON file.');
        }
      };
      input.click();
    });

    // ---------- small utilities ----------
    function initSizesCheckboxes() {
      const sizes = ['XS','S','M','L','XL','XXL'];
      const container = document.getElementById('sizes-container');
      container.innerHTML = sizes.map(s => `<label class="flex items-center gap-2 px-2 py-1 border rounded"><input type="checkbox" class="size-checkbox" value="${s}"><span class="text-sm">${s}</span></label>`).join('');
    }

    // ---------- small search/filter ----------
    document.getElementById('apply-filters').addEventListener('click', () => {
      const q = document.getElementById('filter-search').value.toLowerCase();
      const cat = document.getElementById('filter-category').value.toLowerCase();
      const status = document.getElementById('filter-status').value;
      let filtered = products.slice();
      if (q) filtered = filtered.filter(p => (p.name||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));
      if (cat) filtered = filtered.filter(p => (p.category||'').toLowerCase().includes(cat));
      if (status) filtered = filtered.filter(p => p.status === status);
      renderProductsTable(filtered);
    });

    // global search triggers product filter
    document.getElementById('global-search').addEventListener('input', (e) => {
      document.getElementById('filter-search').value = e.target.value;
      document.getElementById('apply-filters').click();
    });

    // ---------- expose handlers to window (buttons in table call these) ----------
    window.onEditProduct = onEditProduct;
    window.onDuplicateProduct = onDuplicateProduct;
    window.onDeleteProduct = onDeleteProduct;

    // ---------- Initialization ----------
    (function init() {
      // wire top buttons
      document.getElementById('add-product-btn').addEventListener('click', () => {
        isEditing = false; editingProductId = null;
        document.getElementById('modal-title').textContent = 'Add product';
        document.getElementById('product-sku').value = generateSkuCandidate('SKU');
        openProductModal();
      });

      document.getElementById('logout-btn').addEventListener('click', () => {
        toggleLogoutModal(true);
      });

      // Check admin session first
      if (!checkAdminSession()) return;

      initSizesCheckboxes();
      initImageUpload();

      // default view: dashboard
      setActiveSection('dashboard');

      // initial fetch of products (so product count is accurate)
      // Note: we call fetchProducts here but it will also run when user switches to products.
      fetchProducts().catch(()=>{});
    })();

  </script>
</body>
</html>
